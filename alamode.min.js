var version="0.23",alamode={reportError:function(t){$("<h1 class='mode-error'>").text(t).prependTo(document.body)},getColumnsFromQuery:function(t){var e=datasets.filter(function(e){if(e)return e.queryName==t})[0];return e?e.columns:(alamode.reportError("No such query: '"+t+"'"),[])},getDataFromQuery:function(t){var e=datasets.filter(function(e){if(e)return e.queryName==t})[0];return e?e.content:(alamode.reportError("No such query: '"+t+"'"),[])},makeId:function(t){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",a="",n=0;n<t;n++)a+=e.charAt(Math.floor(Math.random()*e.length));return a},addContainerElement:function(t,e){return e=e||!1,id=alamode.makeId(10),"body"==t?$("<div id='"+id+"'></div>").addClass(id).addClass("mode-graphic-container").appendTo(".mode-content"):0===$(t).length?alamode.reportError("No such element: '"+t+"'"):(e&&$(t).empty(),$(t).addClass("mode-graphic-container"),$(t).addClass(id)),"."+id},addLinksToTables:function(t){function e(t){var e=$(a+" table"),n=$(a+" .js-header-table"),r=n?$(a+" .js-col-header"):$(n).find("th"),o=e.find("tr"),i=0;r.each(function(){text=$(this).find(".axel-table-header-label").text(),i=$(this).attr("data-axel-column"),s[text]=i-1}),o.each(function(e){if(e>0&&e<=d.length){var a=$(this).find("td"),n=a.first().attr("data-axel-rowkey");t.forEach(function(t){var e=s[t.column],r=a.eq(e).text();for(url=t.link_string;-1!=url.indexOf("{{");){var o=url.length,i=url.indexOf("{{"),c=url.substring(i+2,o).indexOf("}}"),u=url.substring(i+2,i+c+2),m=url.substring(i,i+c+4),h=(s[u],d[n][u]);url=url.replace(m,h)}var f=l?"_blank":"_top",p="<a target='"+f+"' href='"+encodeURI(url)+"'>"+r+"</a>";a.eq(e).html(p)})}})}var a="#"+t.table_id,n=t.link_columns,r=t.link_urls,o=t.query_name,l=t.open_in_new_tab||!1,i=[],s={};n.forEach(function(t,e){i.push({column:t,link_string:r[e]})});var d=alamode.getDataFromQuery(o);alamode.getColumnsFromQuery(o);setTimeout(function(){e(i)},1e3),$(a).mousemove(function(){e(i)})},customChartColors:function(t){function e(t,e){var a=$("#"+t),n=a.find(".nv-bar").length>0?a.find(".nv-group"):a.find(".nv-line").length>0||a.find(".nv-areaWrap").length>0?a.find(".nv-noninteractive"):a.find(".nv-pie .nv-slice"),r=n.length,o=a.find(".nv-series .nv-legend-symbol"),l={},s={},d={},c=0;if(0==o.length&&r<=1)s[0]=c,d[c]=0,l[0]=e[0];else if(0==o.length&&r>1)for(i=0;i<r;i++)s[i]=i,l=e;else for(i=0;i<o.length;i++)l[i]=e[i%Object.keys(e).length];return o.each(function(t){1==$(this).css("fill-opacity")?(s[t]=c,d[c]=t,c+=1):s[t]=-1}),{chart:a,legend:o,colors:l,m:s,r:d,seriesCount:r}}function a(t,a){var n=e(t,a),r=n.chart,o=n.colors,i=n.m;for(var d in o)r.find(".nv-linesWrap .nv-groups .nv-series-"+i[d]).css({fill:o[d],stroke:o[d]}),r.find(".nv-barsWrap .nv-groups .nv-series-"+i[d]+" rect").css({fill:o[d],stroke:o[d]}),r.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(t){$(this).css({fill:o[0],stroke:o[0]})}),r.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({fill:o[1],stroke:o[1]}),r.find(".nv-scatterWrap .nv-groups .nv-series-"+i[d]).css({fill:o[d],stroke:o[d]}),r.find(".nv-areaWrap .nv-area-"+i[d]).css({fill:o[d],stroke:o[d]}),r.find(".nv-pie .nv-slice").each(function(t){$(this).css({fill:o[t],stroke:o[t]})});for(var d in l)r.find(".nv-linesWrap .nv-groups .nv-series-"+i[d]).css({opacity:l[d]}),r.find(".nv-barsWrap .nv-groups .nv-series-"+i[d]+" rect").css({opacity:l[d]}),0==d&&(r.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").each(function(t){$(this).css({opacity:l[d]})}),r.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css({opacity:l[1]})),r.find(".nv-scatterWrap .nv-groups .nv-series-"+i[d]).css({opacity:l[d]}),r.find(".nv-areaWrap .nv-area-"+i[d]).css({opacity:l[d]}),r.find(".nv-pie .nv-slice").each(function(t){$(this).css({opacity:l[t]})});for(var d in s)r.find(".nv-linesWrap .nv-groups .nv-series-"+i[d]).css({"stroke-dasharray":s[d]});r.find(".nv-legendWrap .nv-series .nv-legend-symbol").each(function(t){$(this).css({fill:o[t],stroke:o[t]})})}function n(t,a){var n=$("#"+t);$(n).mousemove(function(){var r=e(t,a),o=r.legend,l=r.colors,i=r.r,s=r.m,d=r.seriesCount,c=isArea=n.find(".nv-area").length,u=n.find(".nv-bar").length,m=n.find(".nv-line").length;$("html").find(".nvtooltip table .legend-color-guide").each(function(t){if(0==o.length&&0==u)$(this).find("div").css({"background-color":l[s[t]]});else if(m>0&&u>0){var e=n.find(".nv-linePlusBar .nv-linesWrap .nv-groups .nv-series-0").css("fill"),a=n.find(".nv-linePlusBar .nv-barsWrap .nv-bars rect").css("fill");""==$(this).closest(".nvtooltip").find(".key")[0].innerText?$(this).find("div").css("background-color",a):$(this).find("div").css("background-color",e)}else u>0?1==d&&$(this).find("div").css({"background-color":l[i[d-t-1]]}):c>0?$(this).find("div").css({"background-color":l[c-t-1]}):$(this).find("div").css({"background-color":l[t]})});var h=n.find(".nv-pie .nv-slice.hover").css("fill");$("html").find(".nvtooltip table .legend-color-guide div").css("background-color",h)}),$(n).mouseleave(function(){$("html").find(".nvtooltip table .legend-color-guide").remove()})}var r=t.charts,o=t.colors,l=t.opacity,s=t.line_dashes;"all"==r&&(r=[],$("mode-chart").each(function(){r.push(this.id)})),setInterval(function(){r.forEach(function(t){a(t,o)})},500),r.forEach(function(t){n(t,o)})},addTotalsRow:function(t){function e(t){var e="<tr><td>TTL</td>";return t.forEach(function(t){""!=t.total?e=e+"<td class='cell-type-number'>"+d(t.total)+"</td>":e+="<td></td>"}),e+"</tr>"}var a=t.query_name,n=t.table_id||"",r="#"+n,o=alamode.getColumnsFromQuery(a),l=alamode.getDataFromQuery(a),i=t.columns_with_totals,s=t.fmt,d=s||d3.format(","),c=function(t){return numberColumns=_.map(_.filter(o,function(t){return-1!=["number","integer","float"].indexOf(t.type)}),"name"),"all"==t?numberColumns:_.intersection(t,numberColumns)}(i),u=function(t){var e=[];return o.forEach(function(a,n){if(-1==t.indexOf(a.name))var r={idx:n,name:"",total:""};else var o=_.map(l,a.name),i=d3.sum(o),r={idx:n,name:a.name,total:i};e.push(r)}),e}(c);setTimeout(function(){"#"==r?(table=$(".main-table"),container=$(".js-table-content-container")):(table=$(r+" .main-table"),container=$(r+" .js-table-content-container"));var t=table.find("tr:last"),a=e(u),n=container.css("height"),o=+n.match(/\d+/)[0];t.after(a),container.css("height",o+26)},1e3)},addImagesToTables:function(t){function e(){var t=$(a+" table"),e=$(a+" .js-header-table"),o=e?$(a+" .js-col-header"):$(e).find("th"),l=t.find("tr"),i=0;o.each(function(){text=$(this).find(".axel-table-header-label").text(),text==n&&(i=+$(this).attr("data-axel-column"))}),l.each(function(){$(this).find("td").each(function(t){if(t==i-1){var e=$(this).text();0==$(this).find("img").length&&($(this).css("text-align","center"),$(this).html("<img style='height: "+r+"px;' src='"+e+"'>"))}})})}var a="#"+t.table,n=t.column,r=t.image_height||100;setTimeout(function(){e()},1e3),$(a).keyup(function(){setTimeout(function(){e()},500)}),$(a).mousemove(function(){e()})},resizeChartHeight:function(t){var e=t.chart,a=t.height;"python"==e.slice(0,6)?($("#"+e+" .mode-python").css("height",a),$("#"+e+" .mode-python").css("max-height",a),$("#"+e+" img").css("max-height",a)):($("#"+e+" .chart").css("height",a),$("#"+e+" .chart-svg").css("height",a)),window.dispatchEvent(new Event("resize"))},retentionHeatmap:function(t){function e(t){return"cohort_column"===m?C[t.cohort](t.gradientValue):"pivot_column"===m?z[t.pivot](t.gradientValue):A(t.gradientValue)}function a(t){return t.column==c&&""!==t.value}function n(t){var e=r(t.column);return"float"==e||"integer"==e||"number"==e?"heatmap-number":"heatmap-string"}function r(t){return w.filter(function(e){return e.name==t})[0].type}function o(t,e){var a=[{column:s,value:e}];if(f){var n=_.filter(t,function(t){return t[s]==e})[0],r={column:f,value:n[f]};a=a.concat(r)}return $.forEach(function(n){var r="",o="",l=_.filter(t,function(t){return t[s]==e&&t[d]==n});l.length>0&&(r=d3.mean(_.map(l,c)),o=d3.mean(_.map(l,h))),a=a.concat({column:c,value:r,cohort:e,pivot:n,gradientValue:o})}),a}function l(t){var e=r(t.column),a=d3.format(","),n=d3.format("."+x+"%"),o=d3.time.format("%b %d, %Y");return""==t.value?t.value:"datetime"==e||"timestamp"==e||"date"==e?"function"==typeof moment?moment(t.value).utc().format("ll"):o(new Date(t.value)):t.column==f?a(t.value):t.column==c&&y?n(t.value):t.column==c?a(t.value):t.value}var i=t.query_name,s=t.cohort_column,d=t.pivot_column,c=t.value_column,u=t.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],m=t.gradient_by||"all",h=t.gradient_column||c,f=t.total_column,p=t.html_element||"body",v=t.title||i,g=t.pivot_label||"",y=t.value_is_percent,x=t.precision||0,b=alamode.getDataFromQuery(i),w=alamode.getColumnsFromQuery(i),k=_.uniq(_.map(b,s)),$=_.sortBy(_.uniq(_.map(b,d))),E=alamode.addContainerElement(p);if("cohort_column"===m){var C={};k.forEach(function(t){var e=b.filter(function(e){return e[s]===t});C[t]=d3.scale.quantize().domain(d3.extent(e,function(t){return t[h]})).range(u)})}else if("pivot_column"===m){var z={};$.forEach(function(t){var e=b.filter(function(e){return e[d]===t});z[t]=d3.scale.quantize().domain(d3.extent(e,function(t){return t[h]})).range(u)})}else var A=d3.scale.quantize().domain(d3.extent(b,function(t){return t[h]})).range(u);d3.select(E).append("div").attr("class","mode-graphic-title").text(v),d3.select(E).append("div").attr("class","mode-retention-heatmap-label").text(g),headers=f?[s,f].concat($):[s].concat($);var F=d3.select(E).append("table").attr("class","mode-retention-heatmap-table");F.selectAll(".mode-retention-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-retention-heatmap-table-header").selectAll("mode-retention-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(t){return isNaN(t)?"mode-retention-heatmap-table-header-cell heatmap-string":"mode-retention-heatmap-table-header-cell heatmap-number"}).text(function(t){return t}),F.selectAll(".mode-retention-heatmap-table-row").data(k).enter().append("tr").attr("class","mode-retention-heatmap-table-row").selectAll(".mode-retention-heatmap-table-cell").data(function(t){return o(b,t)}).enter().append("td").style("background",function(t){if(a(t))return e(t)}).attr("class",function(t){return n(t)}).text(function(t){return l(t)})},simpleHeatmap:function(t){function e(t){return""!==t.value&&(t.column!=i&&t.column==d)}function a(t){var e=n(t.column);return"float"==e||"integer"==e||"number"==e?"heatmap-number":"heatmap-string"}function n(t){return x.filter(function(e){return e.name==t})[0].type}function r(t,e){var a=[{column:i,value:e}];return w.forEach(function(n){var r=_.filter(t,function(t){return t[i]==e&&t[s]==n});r.length>0?entry=d3.mean(_.map(r,d)):entry=u,a=a.concat({column:d,value:entry})}),a}function o(t){var e=n(t.column),a=d3.format(","),r=d3.format("."+g+"%"),o=d3.time.format("%b %d, %Y");return""==t.value?t.value:"datetime"==e||"timestamp"==e||"date"==e?"function"==typeof moment?moment(t.value).utc().format("ll"):o(new Date(t.value)):t.column==d&&v?r(t.value):t.column==d?a(t.value):t.value}var l=t.query_name,i=t.x_column,s=t.y_column,d=t.value_column,c=t.max_value||Number.MAX_VALUE,u=0===t.min_value?0:t.min_value||Number.MIN_VALUE,m=t.color_gradient||["#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850"],h=t.html_element||"body",f=t.title||l,p=(t.x_label,t.y_label||""),v=t.value_is_percent,g=t.precision||0,y=alamode.getDataFromQuery(l),x=alamode.getColumnsFromQuery(l),b=_.uniq(_.map(y,i)),w=_.uniq(_.map(y,s)),k=alamode.addContainerElement(h),$=d3.scale.quantize().domain(d3.extent(y,function(t){return Math.max(u,Math.min(c,t[d]))})).range(m);d3.select(k).append("div").attr("class","mode-graphic-title").text(f),d3.select(k).append("div").attr("class","mode-simple-heatmap-label").text(p),headers=[i].concat(w);var E=d3.select(k).append("table").attr("class","mode-simple-heatmap-table");E.selectAll(".mode-simple-heatmap-table-header").data([0]).enter().append("tr").attr("class","mode-simple-heatmap-table-header").selectAll("mode-simple-heatmap-table-header-cell").data(headers).enter().append("td").attr("class",function(t){return isNaN(t)?"mode-simple-heatmap-table-header-cell heatmap-string":"mode-simple-heatmap-table-header-cell heatmap-number"}).text(function(t){return t}),E.selectAll(".mode-simple-heatmap-table-row").data(b).enter().append("tr").attr("class","mode-simple-heatmap-table-row").selectAll(".mode-simple-heatmap-table-cell").data(function(t){return r(y,t)}).enter().append("td").style("background",function(t){if(e(t))return $(Math.max(u,Math.min(c,t.value)))}).attr("class",function(t){return a(t)}).text(function(t){return o(t)})},googleMap:function(t){var e=alamode.makeId(10),a=t.lat_column,n=t.lng_column,r=t.query_name,o=t.google_maps_api_key,l=t.title||r,i=t.label_column,s=t.html_element||"body",d=t.center_lat||39.5,c=t.center_lng||-98.35,u=t.starting_zoom||4,m=t.map_type||"terrain",h=t.height||600,f=alamode.getDataFromQuery(r),p=alamode.addContainerElement(s);d3.select(p).append("div").attr("class","mode-graphic-title").text(l),d3.select(p).append("div").attr("class","mode-google-map").attr("id",e).style("height",h+"px"),jQuery.getScript("https://maps.googleapis.com/maps/api/js?key="+o,function(){!function(){var t={zoom:u,center:new google.maps.LatLng(d,c),mapTypeId:m},r=new google.maps.Map(document.getElementById(e),t);f.forEach(function(t){var e=t[a],o=t[n];label=i?t[i]:"";var l=new google.maps.Marker({position:{lat:e,lng:o},map:r,title:label}),s=new google.maps.InfoWindow({content:label});l.addListener("click",function(){s.open(r,l)})})}()})},leafletMap:function(t){var e=alamode.makeId(10),a=t.lat_column,n=t.lng_column,r=t.query_name,o=t.title||r,l=t.height||400,i=t.html_element||"body",s=t.center_lat||39.5,d=t.center_lng||-98.35,c=t.starting_zoom||4,u=t.dot_size||.4,m=t.dot_opacity||.8,h=t.apply_filter||!1,f=alamode.getDataFromQuery(r),p=[];f.forEach(function(t){"number"==typeof t[a]&&"number"==typeof t[n]&&p.push(t)});var v=alamode.addContainerElement(i,h);d3.select(v).style("height",l+"px").append("div").attr("class","mode-graphic-title").text(o);var g=l-$(v+".mode-graphic-title").height(),y=$(v).width();d3.select(v).append("div").attr("class","mode-leaflet-map").attr("id",e).style("height",g+"px").style("width",y+"px");var x=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}),_={max:8,data:p},b={radius:u,maxOpacity:m,scaleRadius:!0,useLocalExtrema:!0,latField:a,lngField:n},w={lat:s,lng:d,zoom:c},k=new HeatmapOverlay(b);new L.Map(e,{center:new L.LatLng(w.lat,w.lng),zoom:Math.floor(w.zoom),layers:[x,k]});k.setData(_)},wordCloud:function(t){function e(t){d3.select(u).append("div").attr("class","mode-wordcloud").append("svg").attr("width",h.size()[0]).attr("height",h.size()[1]).append("g").attr("transform","translate("+h.size()[0]/2+","+h.size()[1]/2+")").selectAll("text").data(t).enter().append("text").style("font-size",function(t){return t.size+"px"}).style("font-family","Impact").style("fill",function(t,e){return d[e%d.length]}).attr("text-anchor","middle").attr("transform",function(t){return"translate("+[t.x,t.y]+")rotate("+t.rotate+")"}).text(function(t){return t.text})}var a=t.query_name,n=t.word_column,r=t.word_count_column,o=t.html_element||"body",l=t.title||a,i=t.height||"400",s=t.width||"800",d=t.colors||["black"],c=alamode.getDataFromQuery(a),u=alamode.addContainerElement(o);d3.select(u).append("div").attr("class","mode-graphic-title").text(l);var m=d3.scale.linear().domain(d3.extent(c,function(t){return t[r]})).range([12,60]),h=d3.layout.cloud().size([s,i]).words(c.map(function(t){return{text:t[n],size:m(t[r])}})).padding(2).rotate(function(){return 360*(~~(6*Math.random())-3)}).font("Impact").fontSize(function(t){return t.size}).on("end",e);h.start()},funnel:function(t){var e=alamode.makeId(10),a=t.query_name,n=t.stage_column,r=t.value_column,o=t.html_element||"body",l=t.title||a,i=t.height||"300",s=t.width||"500",d=alamode.getDataFromQuery(a),c=alamode.addContainerElement(o);d3.select(c).append("div").attr("class","mode-graphic-title").text(l),d3.select(c).append("div").attr("class","mode-funnel").attr("id",e).style("width",s+"px").style("height",i-20+"px");var u=[];d.forEach(function(t){u.push([t[n],t[r]])});var m={label:{format:"{l}: {f}"},block:{dynamicHeight:!0},chart:{bottomPinch:1},animation:100};new D3Funnel("#"+e).draw(u,m),d3.select("#"+e).style("height",i+"px")},horizontalBarChart:function(t){var e=t.query_name,a=(t.bar_column,t.series_columns),n=t.colors||["#EE8D24","#43A5DA","#6AB328","#BB60F8","#E14459","#EAD022","#06D0AD","#DB38B7"];stacked=t.stacked||!1,leftpad=t.left_pad||175,htmlElement=t.html_element||"body",title=t.title||e,height=t.chart_height||395,width=t.width||"500";var r=alamode.getDataFromQuery(e),o=alamode.addContainerElement(htmlElement);d3.select(o).append("div").attr("class","mode-graphic-title").text(title),d3.select(o).append("div").attr("class","mode-horizontal-bar-chart").style("height",height-50+"px").append("svg");var l=[];a.forEach(function(e,a){var o={key:e,color:n[a%n.length]},i=[];r.forEach(function(a){i.push({label:a[t.bar_column],value:a[e]})}),o.values=i,l.push(o)}),nv.addGraph(function(){var t=nv.models.multiBarHorizontalChart().x(function(t){return t.label}).y(function(t){return t.value}).margin({top:30,right:20,bottom:50,left:leftpad}).showValues(!0).showControls(!1).stacked(stacked);return t.yAxis.tickFormat(d3.format(",.2f")),d3.select(o+" svg").datum(l).call(t),nv.utils.windowResize(t.update),t})},chartAnnotations:function(t){function e(){s.forEach(function(t,e){var n=c[e],r=o[e],i=l[e],s=d3.tip().attr("class","d3-tip").style("z-index",100).offset([-10,0]).html(function(t){return t}),d=$(a).find("g.nvd3.nv-wrap").attr("transform"),u=d.indexOf("("),m=d.indexOf(")"),h=d.indexOf(","),f=+d.slice(u+1,h),p=+d.slice(h+1,m);if(-1!=n&&"v"==r){var v=$(a).find(".nv-point.nv-point-"+n).attr("transform"),g=v.indexOf("("),x=v.indexOf(")"),_=v.indexOf(","),b=+v.slice(g+1,_),w=+v.slice(_+1,x),k=($(a).find("g.nvd3.nv-wrap").first().find("rect").first().attr("height"),$(a).find("g.nvd3.nv-wrap").first().find("rect").first().attr("width"),d3.select(a+" .nvd3svg"));k.call(s),k.append("rect").attr("x",b+f).attr("y",p-5).attr("width",1).attr("class","flag").attr("height",w+5).attr("fill","#ff8f53"),k.append("circle").data([t]).attr("cx",b+f).attr("cy",p-5).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",s.show).on("mouseout",s.hide)}else if("h"==r||"h-left"==r||"h-right"==r){y="h"==r?"":"1";var E=$(a).find("g.nv-y"+y+".nv-axis").find(".tick");E.each(function(t){lineLength="h-right"==r?+$(a).find("g.nv-y1.nv-axis").find(".tick").first().find("line").attr("x2"):+$(this).find("line").attr("x2"),tickTrans=$(this).attr("transform"),tickClosePos=tickTrans.indexOf(")"),tickCommaPos=tickTrans.indexOf(","),0==t?(yTrans1=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal1=+$(this).find("text").text().replace(",","")):1==t&&(yTrans2=+tickTrans.slice(tickCommaPos+1,tickClosePos),yVal2=+$(this).find("text").text().replace(",",""))});var C=(yTrans2-yTrans1)/(yVal2-yVal1),z=yTrans2-yVal2*C,A=z+i*C,k=d3.select(a+" .nvd3svg");k.call(s),k.append("rect").attr("x",f).attr("y",A+p).attr("width",lineLength+10).attr("height",1).attr("class","flag").attr("fill","#ff8f53"),k.append("circle").data([t]).attr("cx",lineLength+f+10).attr("cy",A+p).attr("class","flag").attr("r",5).attr("fill","#ff8f53").on("mouseover",s.show).on("mouseout",s.hide)}})}var a="#"+t.chart_id,n=t.x_axis_column,r=t.query_name,o=t.orientations,l=t.comment_values,i=t.group_by,s=t.comments,d=alamode.getDataFromQuery(r),c=[],u={};i&&(u=_.groupBy(d,function(t){return t[i]})),s.forEach(function(t,e){var a=_.filter(d,function(t){return t[n]==l[e]});0!=a.length?pointNumber=i?u[a[0][i]].indexOf(a[0]):d.indexOf(a[0]):pointNumber=-1,c.push(pointNumber)}),setTimeout(function(){d3.select(a).selectAll(".flag").remove(),e()},1e3),$(window).resize(function(){d3.select(a).selectAll(".flag").remove(),m(function(){e()},500,"")});var m=function(){var t={};return function(e,a,n){n||(n="Don't call this twice without a uniqueId"),t[n]&&clearTimeout(t[n]),t[n]=setTimeout(e,a)}}()},bulletChart:function(t){var e=alamode.makeId(10),a=t.query_name,n=t.html_element||"body",r=t.title||a,o=t.chart_width||"800",l=t.bar_column||"",i=t.marker_column||"",s=t.left_pad||150,d=t.color,c=alamode.getDataFromQuery(a),u=alamode.addContainerElement(n);d3.select(u).append("div").attr("class","mode-graphic-title").text(r),d3.select(u).append("div").attr("class","mode-bullet-chart").style("width",o).attr("id",e),c.forEach(function(a){var n=a[t.title_column]||"",r=a[t.subtitle_column]||"",c=a[t.marker_column]||"",u=a[t.bar_column]||"";t.scale_columns?scale=[a[t.scale_columns[0]],a[t.scale_columns[1]],a[t.scale_columns[2]]]:scale=t.scale_columns;var m={title:n,subtitle:r,ranges:scale,measures:[u],measureLabels:[l],markers:[c],markerLabels:[i],color:d};nv.addGraph(function(){var t=nv.models.bulletChart().height(50).width(o).margin({left:s,right:15,top:10,bottom:10});d3.select("#"+e).append("svg").style("width",o+"px").style("height","70px").style("display","inline").datum(m).transition().duration(500).call(t);return t})})},sunburstChart:function(t){function e(t){var e=(100*t.value/E).toPrecision(3),a=e+"%";e<.1&&(a="< 0.1%");var r=n(t),o=t.parent.value,i=(100*t.value/o).toPrecision(3),s=i+"%";i<1&&(a="< 1%"),d3.select("#cond-percentage-"+d).text(s),d3.select("#percentage-"+d).text(a),d3.selectAll(".mode-sunburst-explanation").style("visibility","");var r=n(t);l(r,a),d3.selectAll("path").style("opacity",.3),vis.selectAll("path").filter(function(t){return r.indexOf(t)>=0}).style("opacity",1)}function a(t){d3.select("#trail-"+d).style("visibility","hidden"),d3.selectAll("path").on("mouseover",null),4==d3.version.split(".")[0]?d3.selectAll("path").transition().duration(300).style("opacity",1).on("end",function(){d3.select(this).on("mouseover",e)}):d3.selectAll("path").transition().duration(300).style("opacity",1).each("end",function(){d3.select(this).on("mouseover",e)}),d3.selectAll(".mode-sunburst-explanation").style("visibility","hidden")}function n(t){for(var e=[],a=t;a.parent;)e.unshift(a),a=a.parent;return e}function r(){d3.select("#sequence-"+d).append("svg:svg").attr("width",g).attr("height",60).attr("id","trail-"+d).append("svg:text").attr("id","endlabel").style("fill","#000")}function o(t,e){var a=[];return a.push("0,0"),a.push(b.w+",0"),a.push(b.w+b.t+","+b.h/2),a.push(b.w+","+b.h),a.push("0,"+b.h),e>0&&a.push(b.t+","+b.h/2),a.join(" ")}function l(t,e){var a=d3.select("#trail-"+d).selectAll("g").data(t,function(t){return t.name+t.depth}),n=a.enter().append("svg:g");n.append("svg:polygon").attr("points",o).style("fill",function(t){return $[t.name]}),n.append("svg:text").attr("x",(b.w+b.t)/2).attr("y",b.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(t){return t.name}),a.attr("transform",function(t,e){return e>5&&e<10?"translate("+(e-=5)*(b.w+b.s)+", 20)":e>10?"translate("+(e-=11)*(b.w+b.s)+", 40)":"translate("+e*(b.w+b.s)+", 0)"}),a.exit().remove(),d3.select("#trail-"+d).style("visibility","")}function s(){var t={w:195,h:30,s:3,r:3};d3.entries($).forEach(function(e){divContainer=d3.select("#legend-container-"+d).append("div").attr("class","mode-sunburst-legend").attr("id","legend-"+d),svg=divContainer.append("svg:svg").attr("width",t.w).attr("height",t.h),svg.append("svg:rect").attr("rx",t.r).attr("ry",t.r).attr("width",t.w).attr("height",t.h).style("fill",function(){return e.value}),svg.append("svg:text").attr("x",t.w/2).attr("y",t.h/2).attr("dy","0.35em").attr("text-anchor","middle").text(function(){return e.key})})}var d=alamode.makeId(10),c=t.query_name,u=t.event_columns,m=t.event_counts,h=t.title||c,f=t.color_range||["#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33","#a65628","#f781bf","#999999"],p=t.html_element||"body",v=alamode.getDataFromQuery(c),g=850,y=Math.min(g,600)/2,x=(g-30)/u.length,b={w:x,h:20,s:3,t:10},w=[];u.forEach(function(t){w=w.concat(_.uniq(_.map(v,t)))});var k=_.uniq(w),$={};k.forEach(function(t,e){null!=t&&($[t]=f[e%f.length])}),$.end="#666";var E=0,C=alamode.addContainerElement(p);d3.select(C).append("div").attr("class","mode-graphic-title").text(h),d3.select(C).append("div").attr("class","mode-sunburst-sequence").attr("id","sequence-"+d),d3.select(C).append("div").attr("class","mode-sunburst").attr("id",d),d3.select(C).append("div").attr("class","mode-sunburst-legend-container").attr("id","legend-container-"+d),vis=d3.select("#"+d).append("svg:svg").attr("width",g).attr("height",600).append("svg:g").attr("transform","translate("+g/2+",300)"),vis.append("text").attr("x",0).attr("y",-30).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-percentage").attr("id","percentage-"+d).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",-10).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("of total sequences."),vis.append("text").attr("x",0).attr("y",20).attr("text-anchor","middle").attr("class","mode-sunburst-explanation mode-sunburst-cond-percentage").attr("id","cond-percentage-"+d).style("visibility","hidden").text(""),vis.append("text").attr("x",0).attr("y",40).attr("text-anchor","middle").attr("class","mode-sunburst-explanation").style("visibility","hidden").text("from previous location.");var z=d3.layout.partition().size([2*Math.PI,y*y]).value(function(t){return t.size}),A=d3.svg.arc().startAngle(function(t){return t.x}).endAngle(function(t){return t.x+t.dx}).innerRadius(function(t){return Math.sqrt(t.y)}).outerRadius(function(t){return Math.sqrt(t.y+t.dy)}),F=[];v.forEach(function(t){var e="";for(i=0;i<u.length;i++){if(0!=i?prefix="-~-":prefix="",null==t[u[i]]){e=e+prefix+"end";break}e=e+prefix+t[u[i]]}var a={0:e,1:t[m]};F.push(a)});var M=function(t){for(var e={name:"root",children:[]},a=0;a<t.length;a++){var n=t[a][0],r=+t[a][1];if(!isNaN(r))for(var o=n.split("-~-"),l=e,i=0;i<o.length;i++){var s,d=l.children,c=o[i];if(i+1<o.length){for(var u=!1,m=0;m<d.length;m++)if(d[m].name==c){s=d[m],u=!0;break}u||(s={name:c,children:[]},d.push(s)),l=s}else s={name:c,size:r},d.push(s)}}return e}(F);!function(t){r(),s(),vis.append("svg:circle").attr("r",y).style("opacity",0);var n=z.nodes(t).filter(function(t){return t.dx>.005}),o=vis.data([t]).selectAll("path").data(n).enter().append("svg:path").attr("display",function(t){return t.depth?null:"none"}).attr("d",A).attr("fill-rule","evenodd").style("fill",function(t){return $[t.name]}).style("opacity",1).on("mouseover",e);vis.on("mouseleave",a),E=o.node().__data__.value}(M)},zipcodeChoropleth:function(t){function e(t,e){d3.select("#mode-zipcode-chorolpleth-"+a).append("g").attr("class","zipcodes").selectAll(".mode-zipcode-chorolpleth-zipcodes"+a).data(topojson.feature(e,e.objects.zip_codes_for_the_usa).features).enter().append("path").attr("class","mode-zipcode-chorolpleth-zipcodes-"+a).attr("fill",function(t){return g(h.get(t.properties.zip))}).attr("d",p)}var a=alamode.makeId(10),n=t.query_name,r=t.zipcode_column,o=t.value_column,l=t.width||950,i=t.height||l/1.9,s=t.title||n,d=t.color_range,c=t.color_gradient||["#FFF8CC","#FFF5B2","#FFF299","#E5D87F","#CCBF66","#B2A54C","#998C33","#7F7219","#665900"],u=t.html_element||"body",m=alamode.getDataFromQuery(n),h=d3.map(),f=d3.geoAlbersUsa().scale(l).translate([l/2,i/2]),p=d3.geoPath().projection(f),v=alamode.addContainerElement(u);d3.select(v).append("div").attr("class","mode-graphic-title").text(s),svg=d3.select(v).append("div").attr("class","mode-zipcode-chorolpleth").append("svg").attr("id","mode-zipcode-chorolpleth-"+a).attr("width",l).attr("height",i),m.forEach(function(t){h.set(t[r],+t[o])}),colorDomain=d||d3.extent(m,function(t){return t[o]});var g=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/zips_us_topo.json").await(e)},countyChoropleth:function(t){function e(t,e){d3.select("#mode-county-chorolpleth-"+a).append("g").attr("class","mode-county-chorolpleth-counties").selectAll(".mode-county-chorolpleth-counties"+a).data(topojson.feature(e,e.objects.counties).features).enter().append("path").attr("class","mode-county-chorolpleth-counties-"+a).attr("fill",function(t){return g(h.get(t.id))}).attr("d",p),d3.select("#mode-county-chorolpleth-"+a).append("path").datum(topojson.mesh(e,e.objects.states,function(t,e){return t!==e})).attr("class","mode-county-chorolpleth-states").attr("d",p)}var a=alamode.makeId(10),n=t.query_name,r=t.county_id_column,o=t.value_column,l=t.width||950,i=t.height||l/1.9,s=t.title||n,d=t.color_range,c=t.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],u=t.html_element||"body",m=alamode.getDataFromQuery(n),h=d3.map(),f=d3.geoAlbersUsa().scale(l).translate([l/2,i/2]),p=d3.geoPath().projection(f),v=alamode.addContainerElement(u);d3.select(v).append("div").attr("class","mode-graphic-title").text(s),svg=d3.select(v).append("div").attr("class","mode-county-chorolpleth").append("svg").attr("id","mode-county-chorolpleth-"+a).attr("width",l).attr("height",i),m.forEach(function(t){h.set(t[r],+t[o])}),colorDomain=d||d3.extent(m,function(t){return t[o]});var g=d3.scale.quantize().domain(colorDomain).range(c);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/counties.json").await(e)},stateChoropleth:function(t){function e(t,e){d3.select("#mode-state-chorolpleth-"+a).append("g").attr("class","mode-state-chorolpleth-states").selectAll(".mode-state-chorolpleth-states-"+a).data(e.features).enter().append("path").attr("class","mode-state-chorolpleth-states-"+a).attr("fill",function(t){return y(f.get(t.properties[l]))}).attr("d",v)}var a=alamode.makeId(10),n=t.query_name,r=t.state_column,o=t.value_column,l=t.state_code_type,i=t.width||950,s=t.height||i/1.9,d=t.title||n,c=t.color_range,u=t.color_gradient||["#f7fbff","#deebf7","#c6dbef","#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],m=t.html_element||"body",h=alamode.getDataFromQuery(n),f=d3.map(),p=d3.geoAlbersUsa().scale(i).translate([i/2,s/2]),v=d3.geoPath().projection(p),g=alamode.addContainerElement(m);d3.select(g).append("div").attr("class","mode-graphic-title").text(d),svg=d3.select(g).append("div").attr("class","mode-state-chorolpleth").append("svg").attr("id","mode-state-chorolpleth-"+a).attr("width",i).attr("height",s),h.forEach(function(t){f.set(t[r],+t[o])}),colorDomain=c||d3.extent(h,function(t){return t[o]});var y=d3.scale.quantize().domain(colorDomain).range(u);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/states.json").await(e)},worldChoropleth:function(t){function e(t,e){d3.select("#mode-world-chorolpleth-"+a).append("g").attr("class","mode-world-chorolpleth-countries-base").selectAll(".mode-world-chorolpleth-countries").data(topojson.feature(e,e.objects.countries).features).enter().append("path").attr("class","mode-world-chorolpleth-countries").attr("fill",function(t){return y(f.get(t.properties[l]))}).attr("d",v).on("mouseover",function(t){var e=t.properties.name;f.get(t.properties[l])?value=f.get(t.properties[l]):value="--",d3.select("#mode-world-chorolpleth-legend-"+a).text(e+": "+value)}).on("mouseout",function(t){d3.select("#mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details")}),d3.select("#mode-world-chorolpleth-"+a).append("path").datum(topojson.mesh(e,e.objects.countries,function(t,e){return t!==e})).attr("class","mode-world-chorolpleth-boundaries").attr("d",v)}
var a=alamode.makeId(10),n=t.query_name,r=t.country_column,o=t.value_column,l=t.country_code_type,i=t.width||950,s=t.height||.8*i,d=t.title||n,c=t.color_range,u=t.color_gradient||["#9ecae1","#6baed6","#4292c6","#2171b5","#08519c","#08306b"],m=t.html_element||"body",h=alamode.getDataFromQuery(n),f=d3.map(),p=d3.geo.mercator().scale((i+1)/2/Math.PI).translate([i/2,s/2+.1*s]).precision(.1),v=d3.geoPath().projection(p),g=alamode.addContainerElement(m);d3.select(g).append("div").attr("class","mode-graphic-title").text(d),d3.select(g).append("div").attr("class","mode-world-chorolpleth-legend").attr("id","mode-world-chorolpleth-legend-"+a).text("Hover over a country to see details"),svg=d3.select(g).append("div").attr("class","mode-world-chorolpleth").append("svg").attr("id","mode-world-chorolpleth-"+a).attr("width",i).attr("height",s),h.forEach(function(t){f.set(t[r],+t[o])}),colorDomain=c||d3.extent(h,function(t){return t[o]});var y=d3.scale.quantize().domain(colorDomain).range(u);queue().defer(d3.json,"https://s3-us-west-2.amazonaws.com/mode-alamode/world.json").await(e)},pivotTable:function(t){var e=alamode.makeId(10),a=t.query_name,n=t.default_columns,r=t.default_rows,o=t.default_values,l=t.editable,i=t.aggregate_function||"Count",s=t.pivot_table_type||"Table",d=t.default_column_value||a,c=t.html_element||"body",u=t.default_exclusions||[],m=t.default_inclusions||[];Array.isArray(o)||(o=[o]);var h=alamode.getDataFromQuery(a),f=alamode.getColumnsFromQuery(a),p=_.map(f,"name"),v=alamode.addContainerElement(c);d3.select(v).append("div").attr("class","mode-graphic-title").text(d),d3.select(v).append("div").attr("class","mode-pivot-table").attr("id",e);var g=[];if(g.push(p),h.forEach(function(t){var e=[];p.forEach(function(a){e.push(t[a])}),g.push(e)}),l)$("#"+e).pivotUI(g,{cols:n,rows:r,aggregatorName:i,vals:o,rendererName:s,exclusions:u,inclusions:m});else{var y=$.pivotUtilities,x=y.renderers[s],b=y.aggregators[i];$("#"+e).pivot(g,{cols:n,rows:r,aggregator:b(o),renderer:x,exclusions:u,inclusions:m})}},pieChartLabels:function(t){function e(t,e){t.find(".nv-legendWrap .nv-series text").each(function(a){var n=$(this).text();t.find(".nv-pieWrap .nv-pieLabels text").each(function(t){var r=a+"-"+t;text=$(this).text(),a==t&&""!=text&&text!=o[r]?text=n+" - "+text:a==t&&e&&text!=o[r]&&(text=n),o[r]=text,$(this).text(text)})})}var a=t.show_all_labels,n=t.chart_id,r=$("#"+n),o={};setInterval(function(){e(r,a)},300)},bigNumberSparkline:function(t){var e="#"+t.chart_id,a=t.x_axis_column,n=t.value_column,r=t.query_name,o=alamode.makeId(12),l=alamode.getDataFromQuery(r),i=alamode.getColumnsFromQuery(r);a?(xMatch=_.filter(i,{name:a}),xType=xMatch[0].type):xType="string";var s=[];l.forEach(function(t){"datetime"==xType||"timestamp"==xType||"date"==xType?formattedX=d3.time.format.utc("%Y-%m-%d")(new Date(Date.parse(t[a]))):formattedX=t[a];var e={x:formattedX,y:t[n]};s.push(e)});var d=$(e+" .chart-wrapper"),c=$(e+" .chart-big-number"),u=d.height(),m=d.width(),h=c.height(),f=u-h-20;d3.select(e+" .chart-big-number").append("svg").attr("height",f).attr("width",m).attr("id",o).append("g").attr("transform","translate(0,"+h+")"),nv.addGraph(function(){var t=nv.models.sparklinePlus().margin({left:15,right:15}).x(function(t,e){return e}).xTickFormat(function(t){return s[t].x}).showLastValue(!1);return d3.select("#"+o).datum(s).call(t),t}),setTimeout(function(){d3.selectAll(e+" path").style("stroke-width","2px").style("stroke-linejoin","round").style("stroke","#646C6C"),d3.selectAll(e+" .nv-minValue").style("fill","#EE7437").style("stroke","#EE7437").attr("r",3),d3.selectAll(e+" .nv-maxValue").style("fill","#37B067").style("stroke","#37B067").attr("r",3),d3.selectAll(e+" .nv-currentValue").style("fill","#22A3C0").style("stroke","#22A3C0").attr("r",3)},1e3)},addLinkToBigNumber:function(t){window.ALAMODE_CHARTS=window.ALAMODE_CHARTS||{};var e=t.chart_id.split("_")[1];window.ALAMODE_CHARTS[e]=t.url},forceDirectedGraph:function(t){var e=alamode.makeId(10),a=t.node_query,n=t.edge_query,r=t.html_element||"body",o=t.title||queryName,l=t.chart_width||"800",i=t.chart_height||"800",s=t.group_colors||"",d=t.group_shapes||"",c=t.links_to_show||100,u=alamode.getDataFromQuery(a),m=alamode.getDataFromQuery(n),h=[];m.forEach(function(t){var e=h.filter(function(e){return e.target==t.source}),a=e.filter(function(e){return e.source==t.target});0!=a.length?a.edge_size+=t.edge_size:h.push(t)}),h=h.sort(function(t,e){return e.edge_size-t.edge_size}),h=h.slice(0,c),nameMap={},u.forEach(function(t,e){t.id=e,nameMap[t.node]=e}),h.forEach(function(t){t.source_id=nameMap[t.source],t.target_id=nameMap[t.target]});var f=alamode.addContainerElement(r);d3.select(f).append("div").attr("class","mode-graphic-title").text(o),d3.select(f).append("div").attr("class","mode-force-directed-graph").style("width",l).attr("id",e);var p=d3.tip().attr("class","mode-force-directed-graph-tooltip").offset([-10,0]).html(function(t){return t.node}),v=d3.layout.force().linkDistance(40).linkStrength(1).size([l,i]),g=d3.select("#"+e).append("svg").attr("width",l).attr("height",i);g.call(p);var y={nodes:u,links:h},x=d3.scale.linear().domain(d3.extent(u,function(t){return t.node_size})).range([2,20]),_=d3.scale.linear().domain(d3.extent(h,function(t){return t.edge_size})).range([1,10]),b=d3.scale.linear().domain(d3.extent(h,function(t){return t.edge_size})).range([.1,.9]),u=y.nodes.slice(),h=[],w=[];y.links.forEach(function(t){var e=u[t.source_id],a=u[t.target_id],n={};n.connections=t.edge_size,u.push(n),h.push({source:e,target:n},{source:n,target:a}),w.push([e,n,a])}),v.nodes(u).links(h).start();var k=g.selectAll(".mode-force-directed-graph-link ").data(w).enter().append("path").attr("class","mode-force-directed-graph-link").style("stroke-width",function(t){return _(t[1].connections)}).style("opacity",function(t){return b(t[1].connections)}),$=g.selectAll(".mode-force-directed-graph-node").data(y.nodes).enter().append("g").attr("class","mode-force-directed-graph-node").call(v.drag);$.append("rect").attr("width",function(t){return 2*x(t.node_size)}).attr("height",function(t){return 2*x(t.node_size)}).attr("rx",function(t){return d&&"circle"!==d[t.node_group]?"square"===d[t.node_group]?0:void 0:x(t.node_size)}).style("fill",function(t){return s?s[t.node_group]:"#0E819A"}).on("mouseover",p.show).on("mouseout",p.hide),v.on("tick",function(){k.attr("d",function(t){return"M"+t[0].x+","+t[0].y+"S"+t[1].x+","+t[1].y+" "+t[2].x+","+t[2].y}),$.attr("transform",function(t){return"translate("+(t.x-x(t.node_size))+","+(t.y-x(t.node_size))+")"})})},networkMatrix:function(t){function e(t){d3.select(this).selectAll(".mode-network-matrix-cell").data(t.filter(function(t){return t.z})).enter().append("rect").attr("class","mode-network-matrix-cell").attr("x",function(t){return x(t.x)}).attr("width",x.rangeBand()).attr("height",x.rangeBand()).style("fill-opacity",function(t){return _(t.z)}).style("fill",function(t){return g[t.x].node_group==g[t.y].node_group?h[g[t.x].node_group]:"#2B2B2B"}).on("mouseover",function(t){a(t),w.show(t)}).on("mouseout",function(t){n(),w.hide(t)})}function a(t){d3.selectAll(".mode-network-matrix-row-text").classed("active",function(e,a){return a==t.y}),d3.selectAll(".mode-network-matrix-column-text").classed("active",function(e,a){return a==t.x})}function n(){d3.selectAll("text").classed("active",!1)}function r(t){x.domain(z[t]);var e=$.transition().duration(1e3);e.selectAll(".mode-network-matrix-row").attr("transform",function(t,e){return"translate(0,"+x(e)+")"}).selectAll(".mode-network-matrix-cell").attr("x",function(t){return x(t.x)}),e.selectAll(".mode-network-matrix-column").attr("transform",function(t,e){return"translate("+x(e)+")rotate(-90)"})}var o=alamode.makeId(10),l=t.node_query,i=t.edge_query,s=t.html_element||"body",d=t.title||queryName,c=t.padding_for_names||"200",u=t.chart_width||"800",m=t.chart_height||"800",h=t.group_colors||"",f=t.left_label||"",p=t.top_label||"",v={top:c,right:10,bottom:10,left:c},g=alamode.getDataFromQuery(l),y=alamode.getDataFromQuery(i);nameMap={},g.forEach(function(t,e){t.id=e,nameMap[t.node]=e}),y.forEach(function(t){t.source_id=nameMap[t.source],t.target_id=nameMap[t.target]});var x=d3.scale.ordinal().rangeBands([0,u]),_=d3.scale.linear().domain(d3.extent(y,function(t){return t.edge_size})).clamp(!0),b=alamode.addContainerElement(s);d3.select(b).append("div").attr("class","mode-graphic-title").text(d),d3.select(b).append("div").attr("class","mode-network-matrix-order-picker").html('<p>Order: <select id="mode-network-matrix-order-picker-'+o+'"><option value="name">Name</option><option value="count">Frequency</option><option value="group">Group</option></select>'),d3.select(b).append("div").attr("class","mode-network-matrix").style("width",u).attr("id",o);var w=d3.tip().attr("class","mode-network-matrix-tooltip").offset([-10,0]).html(function(t){return t.z}),k=d3.select("#"+o).append("svg").attr("width",u+v.left+v.right).attr("height",m+v.top+v.bottom);k.call(w);var $=k.append("g").attr("transform","translate("+v.left+","+v.top+")");graph={nodes:g,links:y};var E=[],g=graph.nodes,C=g.length;g.forEach(function(t,e){t.index=e,t.count=0,E[e]=d3.range(C).map(function(t){return{x:t,y:e,z:0}})}),graph.links.forEach(function(t){void 0!==E[t.source_id][t.target_id]?(E[t.source_id][t.target_id].z+=t.edge_size,g[t.source_id].count+=t.edge_size,g[t.target_id].count+=t.edge_size):(E[t.source_id][t.target_id]={},E[t.source_id][t.target_id].z=0)});var z={name:d3.range(C).sort(function(t,e){return d3.ascending(g[t].node,g[e].node)}),count:d3.range(C).sort(function(t,e){return g[e].count-g[t].count}),group:d3.range(C).sort(function(t,e){return d3.ascending(g[t].node_group,g[e].node_group)})};x.domain(z.name),k.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(u+v.left+v.right)/2).attr("y",25).attr("text-anchor","middle").text(p),k.append("text").attr("class","mode-network-matrix-axis-label").attr("x",(m+v.top+v.bottom)/-2).attr("y",25).attr("transform","rotate(-90)").attr("text-anchor","middle").text(f),$.append("rect").attr("class","mode-network-matrix-background").attr("width",u).attr("height",m);var e=$.selectAll(".mode-network-matrix-row").data(E).enter().append("g").attr("class","mode-network-matrix-row").attr("transform",function(t,e){return"translate(0,"+x(e)+")"}).each(e);e.append("line").attr("class","mode-network-matrix-line").attr("x2",u),e.append("text").attr("class","mode-network-matrix-row-text").attr("x",-6).attr("y",x.rangeBand()/2).attr("dy",".32em").attr("text-anchor","end").text(function(t,e){return g[e].node});var A=$.selectAll(".mode-network-matrix-column").data(E).enter().append("g").attr("class","mode-network-matrix-column").attr("transform",function(t,e){return"translate("+x(e)+")rotate(-90)"});A.append("line").attr("class","mode-network-matrix-line").attr("x1",-u),A.append("text").attr("class","mode-network-matrix-column-text").attr("x",6).attr("y",x.rangeBand()/2).attr("dy",".32em").attr("text-anchor","start").text(function(t,e){return g[e].node}),d3.select("#mode-network-matrix-order-picker-"+o).on("change",function(){r(this.value)})},hive:function(t){function e(t){return t/Math.PI*180-90}d3.hive={},d3.hive.link=function(){function t(t,r){var o,l=e(a,this,t,r),i=e(n,this,t,r);l.a>i.a&&(o=i,i=l,l=o),i.a-l.a>Math.PI&&(l.a+=2*Math.PI);var s=l.a+(i.a-l.a)/3,d=i.a-(i.a-l.a)/3;return l.r0-l.r1||i.r0-i.r1?"M"+Math.cos(l.a)*l.r0+","+Math.sin(l.a)*l.r0+"L"+Math.cos(l.a)*l.r1+","+Math.sin(l.a)*l.r1+"C"+Math.cos(s)*l.r1+","+Math.sin(s)*l.r1+" "+Math.cos(d)*i.r1+","+Math.sin(d)*i.r1+" "+Math.cos(i.a)*i.r1+","+Math.sin(i.a)*i.r1+"L"+Math.cos(i.a)*i.r0+","+Math.sin(i.a)*i.r0+"C"+Math.cos(d)*i.r0+","+Math.sin(d)*i.r0+" "+Math.cos(s)*l.r0+","+Math.sin(s)*l.r0+" "+Math.cos(l.a)*l.r0+","+Math.sin(l.a)*l.r0:"M"+Math.cos(l.a)*l.r0+","+Math.sin(l.a)*l.r0+"C"+Math.cos(s)*l.r1+","+Math.sin(s)*l.r1+" "+Math.cos(d)*i.r1+","+Math.sin(d)*i.r1+" "+Math.cos(i.a)*i.r1+","+Math.sin(i.a)*i.r1}function e(t,e,a,n){var s=t.call(e,a,n),d=+("function"==typeof r?r.call(e,s,n):r)+i,c=+("function"==typeof o?o.call(e,s,n):o);return{r0:c,r1:o===l?c:+("function"==typeof l?l.call(e,s,n):l),a:d}}var a=function(t){return t.source},n=function(t){return t.target},r=function(t){return t.angle},o=function(t){return t.radius},l=o,i=-Math.PI/2;return t.source=function(e){return arguments.length?(a=e,t):a},t.target=function(e){return arguments.length?(n=e,t):n},t.angle=function(e){return arguments.length?(r=e,t):r},t.radius=function(e){return arguments.length?(o=l=e,t):o},t.startRadius=function(e){return arguments.length?(o=e,t):o},t.endRadius=function(e){return arguments.length?(l=e,t):l},t};var a=alamode.makeId(10),n=t.node_query,r=t.edge_query,o=t.groups_are_numeric,l=t.html_element||"body",i=t.title||queryName,s=t.chart_width||"800",d=t.chart_height||"800",c=t.group_colors||"",u=Math.min(s,d)/2-30,m=.2*u,h=alamode.getDataFromQuery(n),f=alamode.getDataFromQuery(r),p=_.uniq(_.map(h,"node_group")),v={};h.forEach(function(t){t.x=o?t.node_group:p.indexOf(t.node_group),t.y=t.node_size,v[t.node]=t}),f.forEach(function(t){t.source=v[t.source],t.target=v[t.target]});var g=alamode.addContainerElement(l);d3.select(g).append("div").attr("class","mode-graphic-title").text(i),d3.select(g).append("div").attr("class","mode-network-matrix").style("width",s).attr("id",a),angle=o?d3.scale.linear().domain(d3.extent(h,function(t){return t.node_group})).range([0,2*Math.PI]):d3.scale.ordinal().domain(d3.range(p.length+1)).rangePoints([0,2*Math.PI]);var y=d3.scale.linear().domain(d3.extent(h,function(t){return t.node_size})).range([m,u]),x=d3.tip().attr("class","mode-hive-tooltip").offset([-10,0]).html(function(t){return t.node}),b=d3.select("#"+a).append("svg").attr("width",s).attr("height",d).append("g").attr("transform","translate("+s/2+","+d/2+")");b.call(x),b.selectAll(".mode-hive-axis").data(d3.range(p.length)).enter().append("line").attr("class","mode-hive-axis").attr("transform",function(t){return"rotate("+e(angle(t))+")"}).attr("x1",y.range()[0]).attr("x2",y.range()[1]),b.selectAll(".mode-hive-link").data(f).enter().append("path").attr("class","mode-hive-link").attr("d",d3.hive.link().angle(function(t){return angle(t.x)}).radius(function(t){return y(t.y)})).style("stroke",function(t){return c[t.source.node_group]}),b.selectAll(".mode-hive-node").data(h).enter().append("circle").attr("class","mode-hive-node").attr("transform",function(t){return"rotate("+e(angle(t.x))+")"}).attr("cx",function(t){return y(t.y)}).attr("r",5).style("fill",function(t){return c[t.node_group]}).on("mouseover",function(t){x.show(t),d3.select(this).attr("class","mode-hive-node mode-hive-node-selected"),d3.selectAll(".mode-hive-link").data(f).attr("class",function(e){return e.source.node==t.node?"mode-hive-link-selected":e.target.node==t.node?"mode-hive-link-selected":"mode-hive-link"})}).on("mouseout",function(t){x.hide(t),d3.select(this).attr("class","mode-hive-node"),d3.selectAll(".mode-hive-link-selected").attr("class","mode-hive-link")})},conditionalFormattingByColumn:function(t){function e(t){var e=$(l+" table"),r=$(l+" .js-header-table"),o=r?$(l+" .js-col-header"):$(r).find("th"),i=(e.find("tr"),0);o.each(function(){text=$(this).find(".axel-table-header-label").text(),i=$(this).attr("data-axel-column"),c[text]=i}),t.forEach(function(t){t.rules.forEach(function(e){var r=e.shade_text||!1;"gradient"==e.type?a(t.column,e.color,r):"above"!=e.type&&"below"!=e.type&&"equal"!=e.type||n(t.column,e.type,e.value,e.color,r)})})}function a(t,e,a){var n=d3.extent(_.map(d,t)),r=d3.scale.linear().domain(n).interpolate(d3.interpolateHsl).range(e),i=c[t];d.forEach(function(e,n){var s=l+" table [data-axel-rowkey='"+n+"'][data-axel-column='"+i+"']",d=r(e[t]),c=o(d),u=$(s);a?u.css("color",d):u.css({background:d,color:c})})}function n(t,e,a,n,r){var i=c[t],s=o(n);d.forEach(function(o,d){var c=l+" table [data-axel-rowkey='"+d+"'][data-axel-column='"+i+"']",u=$(c);"above"==e&&o[t]>=a?r?u.css("color",n):u.css({background:n,color:s}):"below"==e&&o[t]<=a?r?u.css("color",n):u.css({background:n,color:s}):"equal"==e&&o[t]==a&&(r?u.css("color",n):u.css({background:n,color:s}))})}function r(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function o(e){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e)?(rgb=r(e),t=Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):t=255,t>125?"#2B2B2B":"#FCFCFC"}var l="#"+t.table_id,i=t.query_name,s=t.column_rules,d=alamode.getDataFromQuery(i),c=(alamode.getColumnsFromQuery(i),{});setTimeout(function(){e(s)},1e3),$(l).mousemove(function(){e(s)})},customizeTable:function(t){window.dispatchAction({type:"Embed.AlamodeCustomizeTable",payload:t})},conditionalFormattingByTable:function(t){function e(t){var e=$(l+" table"),r=$(l+" .js-header-table"),o=r?$(l+" .js-col-header"):$(r).find("th"),i=(e.find("tr"),0);o.each(function(){text=$(this).find(".axel-table-header-label").text(),i=$(this).attr("data-axel-column"),c[text]=i}),t.forEach(function(t){var e=t.shade_text||!1;"gradient"==t.type?a(t.color,e):"above"!=t.type&&"below"!=t.type&&"equal"!=t.type||n(t.type,t.value,t.color,e)})}function a(t,e){var a=d3.scale.linear().domain(m).interpolate(d3.interpolateHsl).range(t);d.forEach(function(t,n){s.forEach(function(r){var i=c[r],s=l+" table [data-axel-rowkey='"+n+"'][data-axel-column='"+i+"']",d=a(t[r]),u=o(d),m=$(s);e?m.css("color",d):m.css({background:d,color:u})})})}function n(t,e,a,n){var r=o(a);d.forEach(function(o,i){s.forEach(function(s){var d=c[s],u=l+" table [data-axel-rowkey='"+i+"'][data-axel-column='"+d+"']",m=$(u);"above"==t&&o[s]>=e?n?m.css("color",a):m.css({background:a,color:r}):"below"==t&&o[s]<=e?n?m.css("color",a):m.css({background:a,color:r}):"equal"==t&&o[s]==e&&(n?m.css("color",a):m.css({background:a,color:r}))})})}function r(t){var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function o(e){return/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e)?(rgb=r(e),t=Math.round((299*parseInt(rgb.r)+587*parseInt(rgb.g)+114*parseInt(rgb.b))/1e3)):t=255,t>125?"#2B2B2B":"#FCFCFC"}var l="#"+t.table_id,i=t.query_name,s=t.columns;rules=t.rules;var d=alamode.getDataFromQuery(i),c=(alamode.getColumnsFromQuery(i),{}),u=[];s.forEach(function(t){var e=d3.extent(_.map(d,t));u=u.concat(e)});var m=d3.extent(u);setTimeout(function(){e(rules)},1e3),$(l).mousemove(function(){e(rules)})},addTableOfContents:function(t){void 0===t&&(t="default");var e=t.text_color,a=t.background_color,n=t.hover_color;$(".mode-header").addClass("has-nav");var r=$("<nav class='fixed-nav-bar'></nav>");$(".row").each(function(){$(this).children().each(function(){var t,e=$(this).find("mode-chart").attr("id")||$(this).find("mode-table").attr("id")||$(this).find("mode-python").attr("id");if(!e)return!0;if(e.includes("chart")||e.includes("table")){var a=document.getElementById(e);t=$(a).find("mode-pivot-table").length>0?document.getElementById(e).getElementsByClassName("in-place-edit-text")[0].innerText:document.getElementById(e).getElementsByClassName("chart-title")[0].innerText}else e.includes("python")&&(t=document.getElementById(e).getElementsByClassName("in-place-edit-text")[0].innerText);var n=$("<a class='scroll-link' href=#"+e+">"+(t.includes("Click to add title")?"Untitled":t)+"</a>");r.append(n)})});var o=$("<div class='mode-grid container''></div>");$(".mode-content").prepend(o);var l=$("<div class='row'></div>");o.prepend(l);var i=$("<div class='col-md-12'></div>");l.prepend(i),i.prepend(r),e&&$(".fixed-nav-bar a").css("color",e),a&&$(".fixed-nav-bar").css("background-color",a),n&&$(".fixed-nav-bar a").hover(function(){$(this).css("color",n)},function(){e?$(this).css("color",e):$(this).css("color","")}),setTimeout(function(){function t(t,e){var a=$(t).offset().top-50;$("html,body").animate({scrollTop:a},e)}$(".scroll-link").on("click",function(e){e.preventDefault(),t($(this).attr("href"),750)})},100)},xAnnotations:function(t){var e=t.chart_id,a=t.comment_values,n=t.comments,r=t.color||[],o=t.is_date||!1;setTimeout(function(){var t=$("#"+e).find("div.highcharts-container")[0],l=t.id,s=Highcharts.charts;if(chart=s.filter(function(t){if(t)return t.container.id==l})[0],data=chart.series[0].data,o)for(i=0;i<a.length;i++)a[i]=new Date(a[i]).getTime();var d=data.filter(function(t){if(t)return a.indexOf(t.category)>=0});chart.update({chart:{events:{load:function(t){for(i=0;i<d.length;i++){var e=d[i],a=r[i]||e.color||"#FCFCFC";t.renderer.label(n[i],e.plotX+t.plotLeft,10,"callout",e.plotX+t.plotLeft,e.plotY+t.plotTop).attr({fill:"#FCFCFC",stroke:a,"stroke-width":1,radius:10,zIndex:4}).add()}}(chart)}}})},250)}};